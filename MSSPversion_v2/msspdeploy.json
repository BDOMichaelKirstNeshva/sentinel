{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "mspOfferName": {
            "type": "string",
            "metadata": {
                "description": "Specify a unique name for your offer"
            },
            "defaultValue": "[BDO Digital GmbH] SOC Central Managed Services"
        },
        "mspOfferDescription": {
            "type": "string",
            "metadata": {
                "description": "Name of the Managed Service Provider offering"
            },
            "defaultValue": "BDO Digital GmbH bietet mit dieser Azure Lighthouse Lösung einen standardisierten \"Managed Security SOC\" basierend auf Microsoft Defender und Azure Sentinel an. Weitere Konnektoren sind in Teilprojekten möglich."
        },
        "managedByTenantId": {
            "type": "string",
            "metadata": {
                "description": "Specify the tenant id of the Managed Service Provider"
            },
            "defaultValue": "97a6baca-7baa-4deb-9e5f-47ff10c7c031"
        },
        "authorizations": {
            "type": "array",
            "metadata": {
                "description": "Specify an array of objects, containing tuples of Azure Active Directory principalId, a Azure roleDefinitionId, and an optional principalIdDisplayName. The roleDefinition specified is granted to the principalId in the provider's Active Directory and the principalIdDisplayName is visible to customers."
            },
            "defaultValue": [
                {
                    "principalId": "c21f11f2-54af-4653-843a-d2ea8f3822ef",
                    "roleDefinitionId": "8d289c81-5878-46d4-8554-54e1e3d8b5cb",
                    "principalIdDisplayName": "[BDO Digital GmbH] MSSP SOC Sentinel Reader"
                },
                {
                    "principalId": "c21f11f2-54af-4653-843a-d2ea8f3822ef",
                    "roleDefinitionId": "39bc4728-0917-49c7-9d2c-d95423bc2eb4",
                    "principalIdDisplayName": "[BDO Digital GmbH] MSSP SOC Sentinel Reader"
                },
                {
                    "principalId": "eee61a73-673c-40c9-b0ef-84fd95ca4737",
                    "roleDefinitionId": "5e467623-bb1f-42f4-a55d-6e525e11384b",
                    "principalIdDisplayName": "[BDO Digital GmbH] MSSP SOC Sentinel Tier 2"
                },
                {
                    "principalId": "eee61a73-673c-40c9-b0ef-84fd95ca4737",
                    "roleDefinitionId": "fb1c8493-542b-48eb-b624-b4c8fea62acd",
                    "principalIdDisplayName": "[BDO Digital GmbH] MSSP SOC Sentinel Tier 2"
               },
                {
                    "principalId": "eee61a73-673c-40c9-b0ef-84fd95ca4737",
                    "roleDefinitionId": "91c1777a-f3dc-4fae-b103-61d183457e46",
                    "principalIdDisplayName": "[BDO Digital GmbH] MSSP SOC Sentinel Tier 2"
                },
                {
                    "principalId": "eee61a73-673c-40c9-b0ef-84fd95ca4737",
                    "roleDefinitionId": "f1a07417-d97a-45cb-824c-7a7467783830",
                    "principalIdDisplayName": "[BDO Digital GmbH] MSSP SOC Sentinel Tier 2"
                },
                {
                    "principalId": "eee61a73-673c-40c9-b0ef-84fd95ca4737",
                    "roleDefinitionId": "f25e0fa2-a7c8-4377-a976-54943a77a395",
                    "principalIdDisplayName": "[BDO Digital GmbH] MSSP SOC Sentinel Tier 2"
                },
                {
                    "principalId": "eee61a73-673c-40c9-b0ef-84fd95ca4737",
                    "roleDefinitionId": "ab8e14d6-4a74-4a29-9ba8-549422addade",
                    "principalIdDisplayName": "[BDO Digital GmbH] MSSP SOC Sentinel Tier 2"
                },
                {
                    "principalId": "b6f266e1-4844-46c5-9f85-166c8b7f4a82",
                    "roleDefinitionId": "3e150937-b8fe-4cfb-8069-0eaf05ecd056",
                    "principalIdDisplayName": "[BDO Digital GmbH] MSSP SOC Sentinel Tier 1"
                },
                {
                    "principalId": "b6f266e1-4844-46c5-9f85-166c8b7f4a82",
                    "roleDefinitionId": "612c2aa1-cb24-443b-ac28-3ab7272de6f5",
                    "principalIdDisplayName": "[BDO Digital GmbH] MSSP SOC Sentinel Tier 1"
                },
                {
                    "principalId": "706bc534-b49b-4b12-a55c-7db6c16ed2b5",
                    "roleDefinitionId": "3e150937-b8fe-4cfb-8069-0eaf05ecd056",
                    "principalIdDisplayName": "[BDO Digital GmbH] SOC Central Managed Services"
                },
                {
                    "principalId": "706bc534-b49b-4b12-a55c-7db6c16ed2b5",
                    "roleDefinitionId": "39bc4728-0917-49c7-9d2c-d95423bc2eb4",
                    "principalIdDisplayName": "[BDO Digital GmbH] SOC Central Managed Services"
                },
                {
                    "principalId": "3c9efb77-ca39-47d0-9b7e-03d3d50b1574",
                    "roleDefinitionId": "f4c81013-99ee-4d62-a7ee-b3f1f648599a",
                    "principalIdDisplayName": "[BDO Digital GmbH] MSSP SOC Sentinel Automation"
                },
                {
                    "principalId": "3c9efb77-ca39-47d0-9b7e-03d3d50b1574",
                    "roleDefinitionId": "ad710c24-b039-4e85-a019-deb4a06e8570",
                    "principalIdDisplayName": "[BDO Digital GmbH] MSSP SOC Sentinel Automation"
                },
                {
                    "principalId": "3c9efb77-ca39-47d0-9b7e-03d3d50b1574",
                    "roleDefinitionId": "51d6186e-6489-4900-b93f-92e23144cca5",
                    "principalIdDisplayName": "[BDO Digital GmbH] MSSP SOC Sentinel Automation"
                },
                {
                    "principalId": "3c9efb77-ca39-47d0-9b7e-03d3d50b1574",
                    "roleDefinitionId": "c18f9900-27b8-47c7-a8f0-5b3b3d4c2bc2",
                    "principalIdDisplayName": "[BDO Digital GmbH] MSSP SOC Sentinel Automation"
                }
            ]
        },
        "rgName": {
            "type": "string",
            "defaultValue": ""
        },
        "location": {
            "type": "string"
        },
        "workspaceName": {
            "type": "string",
            "metadata": {
                "description": "Name for the Log Analytics workspace"
            }
        },
        "pricingTier": {
            "type": "string",
            "metadata": {
                "description": "Pricing tier: pergb2018 or legacy tiers (Free, Standalone, PerNode, Standard or Premium) which are not available to all customers."
            },
            "allowedValues": [
                "PerGB2018",
                "Free",
                "Standalone",
                "PerNode",
                "Standard",
                "Premium"
            ],
            "defaultValue": "PerGB2018"
        },
        "dailyQuota": {
            "type": "int",
            "metadata": {
                "description": "Daily ingestion limit in GBs. This limit doesn't apply to the following tables: SecurityAlert, SecurityBaseline, SecurityBaselineSummary, SecurityDetection, SecurityEvent, WindowsFirewall, MaliciousIPCommunication, LinuxAuditLog, SysmonEvent, ProtectionStatus, WindowsEvent"
            }
        },
        "dataRetention": {
            "type": "int",
            "minValue": 7,
            "maxValue": 730,
            "metadata": {
                "description": "Number of days of retention. Workspaces in the legacy Free pricing tier can only have 7 days."
            },
            "defaultValue": 30
        },
        "immediatePurgeDataOn30Days": {
            "type": "bool",
            "metadata": {
                "description": "If set to true when changing retention to 30 days, older data will be immediately deleted. Use this with extreme caution. This only applies when retention is being set to 30 days."
            },
            "defaultValue": true
        },
        "securityCollectionTier": {
            "type": "string",
            "defaultValue": "Recommended",
            "allowedValues": [
                "All",
                "Recommended",
                "Minimal",
                "None"
            ],
            "metadata": {
                "description": "Tier for gathering Windows Security Events."
            }
        },
        "enableDataConnectorsKind": {
            "type": "array",
            "metadata": {
                "description": "The kind of data connectors that can be deployed via ARM templates are the following: [\"AzureActivityLog\",\"SecurityInsightsSecurityEventCollectionConfiguration\",\"WindowsFirewall\",\"DnsAnalytics\"], Reference: https://docs.microsoft.com/azure/templates/microsoft.operationalinsights/2020-03-01-preview/workspaces/datasources#microsoftoperationalinsightsworkspacesdatasources-object"
            },
            "defaultValue": []
        },
        "enableFusionAlert": {
            "type": "bool",
            "metadata": {
                "description": "Enable Fusion analytics rules"
            },
            "defaultValue": false
        },
        "enableMicrosoftAlerts": {
            "type": "bool",
            "metadata": {
                "description": "Enable Microsoft analytics rules"
            },
            "defaultValue": false
        },
        "enableMLAlerts": {
            "type": "bool",
            "metadata": {
                "description": "Enable ML Behavior Analytics rules"
            },
            "defaultValue": false
        },
        "enableScheduledAlerts": {
            "type": "bool",
            "metadata": {
                "description": "Enable Scheduled analytics rules"
            },
            "defaultValue": false
        },
        "mcasDiscoveryLogs": {
            "type": "bool",
            "metadata": {
                "description": "Enable MCAS Discovery Logs"
            },
            "defaultValue": false
        },
        "_artifactsLocation": {
            "type": "string",
            "metadata": {
                "description": "The location of resources"
            },
            "defaultValue": "https://raw.githubusercontent.com/BDOMichaelKirstNeshva/sentinel/main/MSSPversion_v2/"
        }
    },
    "variables": {
        "mspRegistrationName": "[guid(parameters('mspOfferName'))]",
        "mspAssignmentName": "[guid(parameters('mspOfferName'))]"
    },
    "resources": [
        {
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2020-06-01",
            "name": "[parameters('rgName')]",
            "location": "[parameters('location')]",
            "properties": {}
        },
        {
            "name": "workspaceCreation",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups',parameters('rgName'))]"
            ],
            "resourceGroup": "[parameters('rgName')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), 'LinkedTemplates/workspace.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "workspaceName": {
                        "value": "[parameters('workspaceName')]"
                    },
                    "pricingTier": {
                        "value": "[parameters('pricingTier')]"
                    },
                    "dailyQuota": {
                        "value": "[parameters('dailyQuota')]"
                    },
                    "dataRetention": {
                        "value": "[parameters('dataRetention')]"
                    },
                    "immediatePurgeDataOn30Days": {
                        "value": "[parameters('immediatePurgeDataOn30Days')]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    }
                }
            }
        },
        {
            "condition": "[not(empty(parameters('enableDataConnectorsKind')))]",
            "name": "enableDataConnectorsKind",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "resourceGroup": "[parameters('rgName')]",
            "dependsOn": [
                "workspaceCreation",
                "[resourceId('Microsoft.Resources/resourceGroups',parameters('rgName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), 'LinkedTemplates/dataConnectors.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "dataConnectorsKind": {
                        "value": "[parameters('enableDataConnectorsKind')]"
                    },
                    "workspaceName": {
                        "value": "[parameters('workspaceName')]"
                    },
                    "tenantId": {
                        "value": "[subscription().tenantId]"
                    },
                    "subscriptionId": {
                        "value": "[subscription().subscriptionId]"
                    },
                    "securityCollectionTier": {
                        "value": "[parameters('securityCollectionTier')]"
                    },
                    "mcasDiscoveryLogs": {
                        "value": "[parameters('mcasDiscoveryLogs')]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    }
                }
            }
        },
        {
            "condition": "[or(parameters('enableFusionAlert'),parameters('enableMicrosoftAlerts'),parameters('enableMLAlerts'))]",
            "name": "enableAlerts",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "resourceGroup": "[parameters('rgName')]",
            "dependsOn": [
                "workspaceCreation",
                "[resourceId('Microsoft.Resources/resourceGroups',parameters('rgName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), 'LinkedTemplates/alertRules.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "dataConnectorsKind": {
                        "value": "[parameters('enableDataConnectorsKind')]"
                    },
                    "workspaceName": {
                        "value": "[parameters('workspaceName')]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "enableFusionAlert":{
                        "value": "[parameters('enableFusionAlert')]"
                    },
                    "enableMicrosoftAlerts":{
                        "value": "[parameters('enableMicrosoftAlerts')]"
                    },
                    "enableMLAlerts":{
                        "value": "[parameters('enableMLAlerts')]"
                    }
                }
            }
        },
        {
            "condition": "[parameters('enableScheduledAlerts')]",
            "name": "enableScheduledAlerts",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "resourceGroup": "[parameters('rgName')]",
            "dependsOn": [
                "enableAlerts",
                "[resourceId('Microsoft.Resources/resourceGroups',parameters('rgName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), 'LinkedTemplates/scheduledAlerts.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "workspaceName": {
                        "value": "[parameters('workspaceName')]"
                    },
                    "dataConnectorsList":{
                        "value": "[replace(replace(string(parameters('enableDataConnectorsKind')),'\"',''),'[','')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.ManagedServices/registrationDefinitions",
            "apiVersion": "2019-06-01",
            "name": "[variables('mspRegistrationName')]",
            "properties": {
                "registrationDefinitionName": "[parameters('mspOfferName')]",
                "description": "[parameters('mspOfferDescription')]",
                "managedByTenantId": "[parameters('managedByTenantId')]",
                "authorizations": "[parameters('authorizations')]"
            }
        }
        
    ],
    "outputs": {
        "mspOfferName": {
            "type": "string",
            "value": "[concat('Managed by', ' ', parameters('mspOfferName'))]"
        },
        "authorizations": {
            "type": "array",
            "value": "[parameters('authorizations')]"
        },
        "workspaceName": {
            "type": "string",
            "value": "[parameters('workspaceName')]"
        },
        "dataConnectorsList": {
            "type": "string",
            "value": "[replace(replace(string(parameters('enableDataConnectorsKind')),'\"',''),'[','')]"
        }
    }
}
